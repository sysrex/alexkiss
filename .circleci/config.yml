version: 2
jobs:
  build:
    docker:
      - image: viaops/hugo:latest
    working_directory: ~/hugo
    environment:
      HUGO_BUILD_DIR: ~/hugo/public
    steps:

      # install git
      - run: apk update && apk add git

      # checkout the repository
      - checkout

      # install git submodules for the theme
      - run: git clone https://github.com/naro143/hugo-coder-portfolio themes/coder-portfolio

      - run:
          name: Install AWS CLI (first install pip, the Python package manager)
          command: |
            apk add --update python python-dev py-pip build-base
            pip install awscli

      # build with Hugo
      - run: HUGO_ENV=production hugo -v -d $HUGO_BUILD_DIR
 
  publish:
    docker:
      - image: viaops/hugo:latest
    steps:
      - run:
          name: Publish docker container to Docker Hub
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
              if git log -1 --pretty=%s | grep "\[release\]"; then
                echo "Starting a release"
                docker push viaops/hugo
              else
                echo "Publish the latest image"
                docker tag sysrex/alexkiss:latest sysrex/alexkiss
                docker push sysrex/alexkiss
              fi
            fi
workflows:
  version: 2
  build-master:
    jobs:
      - build:
          filters:
            branches:
              only: master
      - publish:
          requires:
            - build
          filters:
            branches:
              only: master 
